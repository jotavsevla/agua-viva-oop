services:
  postgres-oop-dev:
    image: postgres:16-alpine
    container_name: postgres-oop-dev
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: agua_viva_oop_dev
    ports:
      - "5434:5432"
    volumes:
      - pgdata-oop-dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-oop-test:
    image: postgres:16-alpine
    container_name: postgres-oop-test
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: agua_viva_oop_test
    ports:
      - "5435:5432"
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Nominatim — geocoding local (endereco → lat/lon)
  # Importa o .pbf automaticamente no primeiro start (~30min para MG)
  nominatim:
    image: mediagis/nominatim:4.4
    container_name: nominatim-agua-viva
    environment:
      # Pode ser apontado para um recorte menor (ex.: cidade) para reduzir tempo de import/startup.
      PBF_URL: ${NOMINATIM_PBF_URL:-https://download.geofabrik.de/south-america/brazil/sudeste-latest.osm.pbf}
      NOMINATIM_PASSWORD: nominatim
    ports:
      - "8088:8080"
    volumes:
      - nominatim-data:/var/lib/postgresql/14/main
    shm_size: 1g
    restart: unless-stopped

  # OSRM — servidor de rotas com dados OSM locais
  # Antes de subir: cd solver/osrm && ./prepare.sh
  osrm:
    image: osrm/osrm-backend
    container_name: osrm-agua-viva
    ports:
      - "5000:5000"
    volumes:
      - ./solver/osrm/data:/data
    # Dataset preprocessado em solver/osrm/data (sem extensao .osrm).
    command: osrm-routed --algorithm mld /data/${OSRM_DATASET:-sudeste-latest}.osrm
    restart: unless-stopped

  # Solver Python — otimizador de rotas (OR-Tools + FastAPI)
  solver:
    build: ./solver
    container_name: solver-agua-viva
    ports:
      - "8080:8080"
    environment:
      - OSRM_URL=http://osrm:5000
    depends_on:
      - osrm
    restart: unless-stopped

volumes:
  pgdata-oop-dev:
  nominatim-data:
