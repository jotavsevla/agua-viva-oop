services:
  postgres-oop-dev:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: agua_viva_oop_dev
    ports:
      - "${POSTGRES_DEV_PORT:-5434}:5432"
    volumes:
      - pgdata-oop-dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-oop-test:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: agua_viva_oop_test
    ports:
      - "${POSTGRES_TEST_PORT:-5435}:5432"
    tmpfs:
      - /var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Nominatim — geocoding local (endereco → lat/lon)
  # Importa o .pbf automaticamente no primeiro start (~30min para MG)
  nominatim:
    image: mediagis/nominatim:4.4
    environment:
      # Pode ser apontado para um recorte menor (ex.: cidade) para reduzir tempo de import/startup.
      PBF_URL: ${NOMINATIM_PBF_URL:-https://download.geofabrik.de/south-america/brazil/sudeste-latest.osm.pbf}
      NOMINATIM_PASSWORD: ${NOMINATIM_PASSWORD:-nominatim}
    ports:
      - "${NOMINATIM_PORT:-8088}:8080"
    volumes:
      - nominatim-data:/var/lib/postgresql/14/main
    shm_size: 1g
    restart: unless-stopped

  # OSRM — servidor de rotas com dados OSM locais
  # Antes de subir: cd solver/osrm && ./prepare.sh
  osrm:
    image: osrm/osrm-backend
    ports:
      - "${OSRM_PORT:-5000}:5000"
    volumes:
      - ./solver/osrm/data:/data
    # Dataset preprocessado em solver/osrm/data (sem extensao .osrm).
    command: osrm-routed --algorithm mld /data/${OSRM_DATASET:-sudeste-latest}.osrm
    restart: unless-stopped

  # Solver Python — otimizador de rotas (OR-Tools + FastAPI)
  solver:
    build: ./solver
    ports:
      - "${SOLVER_PORT:-8080}:8080"
    environment:
      - OSRM_URL=http://osrm:5000
    depends_on:
      - osrm
    restart: unless-stopped

  # API Java — backend principal
  api:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${API_PORT:-8082}:8082"
    volumes:
      - ./config:/app/config:ro
    environment:
      APP_ENV: ${APP_ENV:-local}
      POSTGRES_HOST: ${API_POSTGRES_HOST:-postgres-oop-test}
      POSTGRES_PORT: "5432"
      POSTGRES_DB: ${API_POSTGRES_DB:-agua_viva_oop_test}
      POSTGRES_USER: ${API_POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_PASSWORD_FILE: ${POSTGRES_PASSWORD_FILE:-}
      SOLVER_URL: ${API_SOLVER_URL:-http://solver:8080}
      API_PORT: "8082"
      API_CONFIG_FILE: ${API_CONFIG_FILE:-/app/config/api-config.local.json}
    depends_on:
      - postgres-oop-test
      - solver
    restart: unless-stopped

  # Runner de migrations para testes (uso: docker compose run --rm migrations-test)
  migrations-test:
    image: postgres:16-alpine
    profiles: ["test"]
    working_dir: /workspace
    volumes:
      - .:/workspace
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD:-postgres}
    command: >
      sh -lc '
      until pg_isready -h postgres-oop-test -p 5432 -U postgres -d agua_viva_oop_test; do
        sleep 1;
      done;
      for file in /workspace/sql/migrations/*.sql; do
        echo "Aplicando migration: $$file";
        psql -h postgres-oop-test -p 5432 -U postgres -d agua_viva_oop_test -v ON_ERROR_STOP=1 -f "$$file";
      done
      '
    depends_on:
      - postgres-oop-test

  # Suite Java (unit + integration) em container
  test-java:
    image: maven:3.9.11-eclipse-temurin-25
    profiles: ["test"]
    working_dir: /workspace
    volumes:
      - .:/workspace
      - m2-cache:/root/.m2
    environment:
      POSTGRES_HOST: postgres-oop-test
      POSTGRES_PORT: "5432"
      POSTGRES_DB: agua_viva_oop_test
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_PASSWORD_FILE: ${POSTGRES_PASSWORD_FILE:-}
      SOLVER_URL: http://solver:8080
    command: >
      sh -lc '
      mvn -DskipTests spotless:check &&
      mvn -Ptests-unit test &&
      mvn -Ptests-integration test
      '
    depends_on:
      - postgres-oop-test
      - solver

  # Suite solver Python em container
  test-solver:
    image: python:3.12-slim
    profiles: ["test"]
    working_dir: /workspace
    volumes:
      - .:/workspace
      - pip-cache:/root/.cache/pip
    command: >
      sh -lc '
      pip install --no-cache-dir -r solver/requirements.txt &&
      python -m pytest -q solver/tests
      '

  # Smoke tests de UI (Node) em container
  test-ui-node:
    image: node:20-bookworm-slim
    profiles: ["test"]
    working_dir: /workspace/produto-ui/prototipo
    volumes:
      - .:/workspace
      - npm-cache:/root/.npm
    command: >
      sh -lc '
      npm ci &&
      npm run test:node
      '

volumes:
  pgdata-oop-dev:
  nominatim-data:
  m2-cache:
  pip-cache:
  npm-cache:
