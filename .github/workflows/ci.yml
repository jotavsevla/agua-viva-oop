name: CI

on:
  push:
  pull_request:
  schedule:
    - cron: "0 5 * * *"

permissions:
  contents: read

jobs:
  style-check:
    name: style-check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve diff base
        id: base
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "sha=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "sha=${{ github.event.before }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Run style script on changed files
        run: |
          BASE_SHA="${{ steps.base.outputs.sha }}"
          if [[ -z "$BASE_SHA" || "$BASE_SHA" == "0000000000000000000000000000000000000000" ]]; then
            echo "Base SHA invalido; checando repositorio inteiro."
            scripts/check-style.sh
            exit 0
          fi

          mapfile -t changed_files < <(git diff --name-only --diff-filter=ACMRT "$BASE_SHA" "$GITHUB_SHA")
          if [[ ${#changed_files[@]} -eq 0 ]]; then
            echo "Nenhum arquivo alterado para checar."
            exit 0
          fi

          scripts/check-style.sh "${changed_files[@]}"

  java-tests:
    name: java-tests
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Java tests in container
        run: scripts/tests/run-container-tests.sh --skip-solver --skip-ui

  solver-tests:
    name: solver-tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run solver tests in container
        run: docker compose -f compose.yml --profile test run --rm test-solver

  ui-tests:
    name: ui-tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run UI smoke tests in container
        run: docker compose -f compose.yml --profile test run --rm test-ui-node

  bootstrap-smoke-matrix:
    name: bootstrap-smoke-matrix
    runs-on: ${{ matrix.os }}
    timeout-minutes: 35
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Normalize line endings (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git config --global core.autocrlf false
          git reset --hard HEAD

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"
          cache: maven

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: solver/requirements.txt

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: produto-ui/prototipo/package-lock.json

      - name: Bootstrap dependencies (macOS/Linux)
        if: runner.os != 'Windows'
        run: scripts/bootstrap-dev.sh

      - name: Bootstrap dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: .\scripts\bootstrap-dev.ps1

      - name: Bootstrap smoke complete
        run: echo "Bootstrap smoke finalizado com sucesso."

  business-gate-pr:
    name: business-gate-pr
    if: ${{ github.event_name != 'schedule' }}
    runs-on: ubuntu-latest
    timeout-minutes: 70

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"
          cache: maven

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run business gate (strict, PR deterministic slice)
        run: |
          PR_BUSINESS_CHECKS="R01,R02,R03,R04,R05,R06,R07,R08,R09,R10,R13,R14,R15,R16,R23,R24,R25,R26,R27,R28,R29,R30,R31,R33,R34,R35,R36,R37,R38,R39,R40,R41,R42,R43,R44,R45,R46,R47,R48,R49"
          SCENARIO=feliz scripts/poc/run-business-gate.sh --mode strict --rounds 1 --only-check "$PR_BUSINESS_CHECKS"

      - name: Upload business gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: business-gate-pr-artifacts
          path: artifacts/poc/business-gate-*
          if-no-files-found: warn

  business-gate-nightly:
    name: business-gate-nightly
    if: ${{ github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    timeout-minutes: 110

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"
          cache: maven

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run business gate (strict, 3 rodadas)
        run: scripts/poc/run-business-gate.sh --mode strict --rounds 3

      - name: Upload business gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: business-gate-nightly-artifacts
          path: artifacts/poc/business-gate-*
          if-no-files-found: warn
