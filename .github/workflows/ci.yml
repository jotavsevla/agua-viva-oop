name: CI

on:
  push:
  pull_request:
  schedule:
    - cron: "0 5 * * *"

permissions:
  contents: read

jobs:
  style-check:
    name: style-check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true # Rollout gradual: nao bloqueia merge nesta fase inicial.

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve diff base
        id: base
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "sha=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "sha=${{ github.event.before }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Run style script on changed files
        run: |
          BASE_SHA="${{ steps.base.outputs.sha }}"
          if [[ -z "$BASE_SHA" || "$BASE_SHA" == "0000000000000000000000000000000000000000" ]]; then
            echo "Base SHA invalido; checando repositorio inteiro."
            scripts/check-style.sh
            exit 0
          fi

          mapfile -t changed_files < <(git diff --name-only --diff-filter=ACMRT "$BASE_SHA" "$GITHUB_SHA")
          if [[ ${#changed_files[@]} -eq 0 ]]; then
            echo "Nenhum arquivo alterado para checar."
            exit 0
          fi

          scripts/check-style.sh "${changed_files[@]}"

  java-tests:
    name: java-tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: agua_viva_oop_test
        ports:
          - 5435:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d agua_viva_oop_test"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL
        env:
          PGPASSWORD: postgres
        run: |
          for i in {1..30}; do
            if pg_isready -h localhost -p 5435 -U postgres -d agua_viva_oop_test; then
              exit 0
            fi
            sleep 2
          done
          echo "PostgreSQL nao ficou pronto a tempo."
          exit 1

      - name: Apply migrations
        env:
          PGPASSWORD: postgres
        run: |
          set -e
          for file in sql/migrations/*.sql; do
            echo "Aplicando migration: $file"
            psql \
              -h localhost \
              -p 5435 \
              -U postgres \
              -d agua_viva_oop_test \
              -v ON_ERROR_STOP=1 \
              -f "$file"
          done

      - name: Run Java tests
        run: mvn test

  solver-tests:
    name: solver-tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: solver/requirements.txt

      - name: Create solver virtualenv
        run: python -m venv solver/.venv

      - name: Install solver dependencies
        run: solver/.venv/bin/pip install -r solver/requirements.txt

      - name: Run solver tests
        run: solver/.venv/bin/python -m pytest -q solver/tests

  business-gate-pr:
    name: business-gate-pr
    if: ${{ github.event_name != 'schedule' }}
    runs-on: ubuntu-latest
    timeout-minutes: 70

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run business gate (strict, 1 rodada)
        run: scripts/poc/run-business-gate.sh --mode strict --rounds 1

      - name: Upload business gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: business-gate-pr-artifacts
          path: artifacts/poc/business-gate-*
          if-no-files-found: warn

  business-gate-nightly:
    name: business-gate-nightly
    if: ${{ github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    timeout-minutes: 110

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run business gate (strict, 3 rodadas)
        run: scripts/poc/run-business-gate.sh --mode strict --rounds 3

      - name: Upload business gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: business-gate-nightly-artifacts
          path: artifacts/poc/business-gate-*
          if-no-files-found: warn
